# 核心代码示例与开发规范

## 1. 统一返回结果 (Result.java)

```java
package com.assessment.common;

import lombok.Data;
import java.io.Serializable;

/**
 * 统一返回结果
 * @author 开发团队
 */
@Data
public class Result<T> implements Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * 状态码
     */
    private Integer code;

    /**
     * 提示信息
     */
    private String message;

    /**
     * 数据体
     */
    private T data;

    /**
     * 时间戳
     */
    private Long timestamp;

    public Result() {
        this.timestamp = System.currentTimeMillis();
    }

    public static <T> Result<T> success() {
        Result<T> result = new Result<>();
        result.setCode(200);
        result.setMessage("success");
        return result;
    }

    public static <T> Result<T> success(T data) {
        Result<T> result = new Result<>();
        result.setCode(200);
        result.setMessage("success");
        result.setData(data);
        return result;
    }

    public static <T> Result<T> success(String message, T data) {
        Result<T> result = new Result<>();
        result.setCode(200);
        result.setMessage(message);
        result.setData(data);
        return result;
    }

    public static <T> Result<T> error(Integer code, String message) {
        Result<T> result = new Result<>();
        result.setCode(code);
        result.setMessage(message);
        return result;
    }

    public static <T> Result<T> error(String message) {
        return error(500, message);
    }
}
```

## 2. 分页返回结果 (PageResult.java)

```java
package com.assessment.common;

import lombok.Data;
import java.io.Serializable;
import java.util.List;

/**
 * 分页返回结果
 */
@Data
public class PageResult<T> implements Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * 数据列表
     */
    private List<T> items;

    /**
     * 分页信息
     */
    private Pagination pagination;

    @Data
    public static class Pagination {
        /**
         * 当前页码
         */
        private Integer page;

        /**
         * 每页数量
         */
        private Integer pageSize;

        /**
         * 总记录数
         */
        private Long total;

        /**
         * 总页数
         */
        private Integer totalPages;

        public Pagination(Integer page, Integer pageSize, Long total) {
            this.page = page;
            this.pageSize = pageSize;
            this.total = total;
            this.totalPages = (int) Math.ceil((double) total / pageSize);
        }
    }

    public PageResult(List<T> items, Integer page, Integer pageSize, Long total) {
        this.items = items;
        this.pagination = new Pagination(page, pageSize, total);
    }
}
```

## 3. 全局异常处理 (GlobalExceptionHandler.java)

```java
package com.assessment.exception;

import com.assessment.common.Result;
import lombok.extern.slf4j.Slf4j;
import org.springframework.validation.BindException;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import javax.servlet.http.HttpServletRequest;

/**
 * 全局异常处理器
 */
@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    /**
     * 业务异常
     */
    @ExceptionHandler(BusinessException.class)
    public Result<?> handleBusinessException(BusinessException e, HttpServletRequest request) {
        log.error("业务异常: {}, URI: {}", e.getMessage(), request.getRequestURI());
        return Result.error(e.getCode(), e.getMessage());
    }

    /**
     * 资源不存在异常
     */
    @ExceptionHandler(ResourceNotFoundException.class)
    public Result<?> handleResourceNotFoundException(ResourceNotFoundException e) {
        log.error("资源不存在: {}", e.getMessage());
        return Result.error(404, e.getMessage());
    }

    /**
     * 参数校验异常
     */
    @ExceptionHandler({MethodArgumentNotValidException.class, BindException.class})
    public Result<?> handleValidationException(Exception e) {
        String message = "参数校验失败";
        if (e instanceof MethodArgumentNotValidException) {
            MethodArgumentNotValidException ex = (MethodArgumentNotValidException) e;
            if (ex.getBindingResult().hasErrors()) {
                message = ex.getBindingResult().getAllErrors().get(0).getDefaultMessage();
            }
        }
        log.error("参数校验异常: {}", message);
        return Result.error(400, message);
    }

    /**
     * 系统异常
     */
    @ExceptionHandler(Exception.class)
    public Result<?> handleException(Exception e, HttpServletRequest request) {
        log.error("系统异常: {}, URI: {}", e.getMessage(), request.getRequestURI(), e);
        return Result.error(500, "系统异常，请联系管理员");
    }
}
```

## 4. 业务异常类 (BusinessException.java)

```java
package com.assessment.exception;

import lombok.Data;
import lombok.EqualsAndHashCode;

/**
 * 业务异常
 */
@Data
@EqualsAndHashCode(callSuper = true)
public class BusinessException extends RuntimeException {
    private Integer code;
    private String message;

    public BusinessException(String message) {
        super(message);
        this.code = 500;
        this.message = message;
    }

    public BusinessException(Integer code, String message) {
        super(message);
        this.code = code;
        this.message = message;
    }
}
```

## 5. Controller 示例 (GradeController.java)

```java
package com.assessment.controller;

import com.assessment.common.Result;
import com.assessment.common.PageResult;
import com.assessment.dto.request.GradeCreateRequest;
import com.assessment.dto.response.GradeResponse;
import com.assessment.service.IGradeService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

/**
 * 成绩管理控制器
 */
@Tag(name = "成绩管理", description = "成绩相关接口")
@RestController
@RequestMapping("/v1/grades")
@RequiredArgsConstructor
public class GradeController {

    private final IGradeService gradeService;

    @Operation(summary = "获取学生成绩列表")
    @GetMapping("/student/{studentId}")
    public Result<PageResult<GradeResponse>> getStudentGrades(
            @Parameter(description = "学生ID") @PathVariable Long studentId,
            @Parameter(description = "课程ID") @RequestParam(required = false) Long courseId,
            @Parameter(description = "成绩类型") @RequestParam(required = false) String type,
            @Parameter(description = "页码") @RequestParam(defaultValue = "1") Integer page,
            @Parameter(description = "每页数量") @RequestParam(defaultValue = "20") Integer pageSize
    ) {
        PageResult<GradeResponse> result = gradeService.getStudentGrades(
                studentId, courseId, type, page, pageSize);
        return Result.success(result);
    }

    @Operation(summary = "添加成绩")
    @PostMapping
    public Result<Long> createGrade(@Validated @RequestBody GradeCreateRequest request) {
        Long gradeId = gradeService.createGrade(request);
        return Result.success("成绩添加成功", gradeId);
    }

    @Operation(summary = "更新成绩")
    @PutMapping("/{id}")
    public Result<Void> updateGrade(
            @PathVariable Long id,
            @Validated @RequestBody GradeCreateRequest request
    ) {
        gradeService.updateGrade(id, request);
        return Result.success("成绩更新成功", null);
    }

    @Operation(summary = "删除成绩")
    @DeleteMapping("/{id}")
    public Result<Void> deleteGrade(@PathVariable Long id) {
        gradeService.deleteGrade(id);
        return Result.success("成绩删除成功", null);
    }
}
```

## 6. Service 示例 (GradeServiceImpl.java)

```java
package com.assessment.service.impl;

import com.assessment.common.PageResult;
import com.assessment.dto.request.GradeCreateRequest;
import com.assessment.dto.response.GradeResponse;
import com.assessment.entity.Grade;
import com.assessment.exception.BusinessException;
import com.assessment.exception.ResourceNotFoundException;
import com.assessment.mapper.GradeMapper;
import com.assessment.service.IGradeService;
import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

/**
 * 成绩服务实现类
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class GradeServiceImpl implements IGradeService {

    private final GradeMapper gradeMapper;

    @Override
    public PageResult<GradeResponse> getStudentGrades(
            Long studentId, Long courseId, String type, Integer page, Integer pageSize) {

        // 构建查询条件
        LambdaQueryWrapper<Grade> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(Grade::getStudentId, studentId)
                .eq(courseId != null, Grade::getCourseId, courseId)
                .eq(type != null, Grade::getType, type)
                .eq(Grade::getStatus, "published")
                .orderByDesc(Grade::getCreatedAt);

        // 分页查询
        Page<Grade> pageParam = new Page<>(page, pageSize);
        Page<Grade> pageResult = gradeMapper.selectPage(pageParam, queryWrapper);

        // 转换为DTO
        List<GradeResponse> grades = pageResult.getRecords().stream()
                .map(this::convertToResponse)
                .collect(Collectors.toList());

        return new PageResult<>(grades, page, pageSize, pageResult.getTotal());
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public Long createGrade(GradeCreateRequest request) {
        // 数据校验
        validateGradeRequest(request);

        // 构建实体
        Grade grade = new Grade();
        grade.setStudentId(request.getStudentId());
        grade.setCourseId(request.getCourseId());
        grade.setScore(request.getScore());
        grade.setTotalScore(request.getTotalScore());
        grade.setPercentage(request.getScore() / request.getTotalScore() * 100);
        grade.setType(request.getType());
        grade.setStatus("draft");

        // 保存
        int result = gradeMapper.insert(grade);
        if (result <= 0) {
            throw new BusinessException("成绩添加失败");
        }

        log.info("成绩添加成功，ID: {}", grade.getId());
        return grade.getId();
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void updateGrade(Long id, GradeCreateRequest request) {
        // 检查成绩是否存在
        Grade grade = gradeMapper.selectById(id);
        if (grade == null) {
            throw new ResourceNotFoundException("成绩不存在，ID: " + id);
        }

        // 更新数据
        grade.setScore(request.getScore());
        grade.setTotalScore(request.getTotalScore());
        grade.setPercentage(request.getScore() / request.getTotalScore() * 100);
        grade.setComment(request.getComment());

        int result = gradeMapper.updateById(grade);
        if (result <= 0) {
            throw new BusinessException("成绩更新失败");
        }

        log.info("成绩更新成功，ID: {}", id);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void deleteGrade(Long id) {
        Grade grade = gradeMapper.selectById(id);
        if (grade == null) {
            throw new ResourceNotFoundException("成绩不存在，ID: " + id);
        }

        int result = gradeMapper.deleteById(id);
        if (result <= 0) {
            throw new BusinessException("成绩删除失败");
        }

        log.info("成绩删除成功，ID: {}", id);
    }

    // 私有方法
    private void validateGradeRequest(GradeCreateRequest request) {
        if (request.getScore() > request.getTotalScore()) {
            throw new BusinessException("分数不能大于总分");
        }
        if (request.getScore() < 0) {
            throw new BusinessException("分数不能为负数");
        }
    }

    private GradeResponse convertToResponse(Grade grade) {
        GradeResponse response = new GradeResponse();
        response.setId(grade.getId());
        response.setStudentId(grade.getStudentId());
        response.setCourseId(grade.getCourseId());
        response.setScore(grade.getScore());
        response.setTotalScore(grade.getTotalScore());
        response.setPercentage(grade.getPercentage());
        response.setType(grade.getType());
        response.setCreatedAt(grade.getCreatedAt());
        return response;
    }
}
```

## 7. Entity 示例 (Grade.java)

```java
package com.assessment.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.io.Serializable;
import java.math.BigDecimal;
import java.time.LocalDateTime;

/**
 * 成绩实体类
 */
@Data
@TableName("grade")
public class Grade implements Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * 成绩ID
     */
    @TableId(value = "id", type = IdType.AUTO)
    private Long id;

    /**
     * 学生ID
     */
    private Long studentId;

    /**
     * 课程ID
     */
    private Long courseId;

    /**
     * 考试ID
     */
    private Long examId;

    /**
     * 任务ID
     */
    private Long taskId;

    /**
     * 分数
     */
    private BigDecimal score;

    /**
     * 总分
     */
    private BigDecimal totalScore;

    /**
     * 百分比
     */
    private BigDecimal percentage;

    /**
     * 排名
     */
    private Integer rank;

    /**
     * 成绩类型
     */
    private String type;

    /**
     * 状态
     */
    private String status;

    /**
     * 评语
     */
    private String comment;

    /**
     * 批改人ID
     */
    private Long gradedBy;

    /**
     * 批改时间
     */
    private LocalDateTime gradedAt;

    /**
     * 创建时间
     */
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createdAt;

    /**
     * 更新时间
     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updatedAt;

    /**
     * 逻辑删除标记
     */
    @TableLogic
    private Integer deleted;
}
```

## 8. Mapper 示例 (GradeMapper.java)

```java
package com.assessment.mapper;

import com.assessment.entity.Grade;
import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;

import java.math.BigDecimal;
import java.util.List;

/**
 * 成绩Mapper接口
 */
@Mapper
public interface GradeMapper extends BaseMapper<Grade> {

    /**
     * 获取班级平均分
     */
    @Select("SELECT AVG(score) FROM grade " +
            "WHERE course_id = #{courseId} AND exam_id = #{examId} AND deleted = 0")
    BigDecimal getClassAverageScore(@Param("courseId") Long courseId, @Param("examId") Long examId);

    /**
     * 获取学生排名
     */
    @Select("SELECT COUNT(*) + 1 FROM grade " +
            "WHERE course_id = #{courseId} AND exam_id = #{examId} " +
            "AND score > (SELECT score FROM grade WHERE id = #{gradeId}) AND deleted = 0")
    Integer getStudentRank(@Param("courseId") Long courseId,
                          @Param("examId") Long examId,
                          @Param("gradeId") Long gradeId);
}
```
