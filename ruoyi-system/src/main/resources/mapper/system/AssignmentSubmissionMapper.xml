<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.AssignmentSubmissionMapper">

    <resultMap id="AssignmentSubmissionResult" type="com.ruoyi.system.domain.AssignmentSubmission">
        <id property="id" column="id"/>
        <result property="assignmentId" column="assignment_id"/>
        <result property="studentUserId" column="student_user_id"/>
        <result property="status" column="status"/>
        <result property="score" column="score"/>
        <result property="feedback" column="feedback"/>
        <result property="submitTime" column="submit_time"/>
        <result property="gradeTime" column="grade_time"/>
        <result property="gradedBy" column="graded_by"/>
        <result property="content" column="content"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="fileName" column="file_name"/>
        <result property="filePath" column="file_path"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="deleteTime" column="delete_time"/>
        <result property="studentName" column="student_name"/>
        <result property="studentUsername" column="student_username"/>
        <result property="gradedByName" column="graded_by_name"/>
    </resultMap>

    <select id="selectAssignmentSubmissionList" parameterType="com.ruoyi.system.domain.AssignmentSubmission"
            resultMap="AssignmentSubmissionResult">
        SELECT
            s.id,
            s.assignment_id,
            s.student_user_id,
            s.status,
            s.score,
            s.feedback,
            s.submit_time,
            s.grade_time,
            s.graded_by,
            s.content,
            s.create_time,
            s.update_time,
            s.file_name,
            s.file_path,
            s.is_deleted,
            s.delete_time,
            u.real_name AS student_name,
            u.username AS student_username,
            grader.real_name AS graded_by_name
        FROM assignment_submission s
                 LEFT JOIN `user` u ON s.student_user_id = u.id
                 LEFT JOIN `user` grader ON s.graded_by = grader.id
        <where>
            s.is_deleted = 0
            <if test="assignmentId != null">
                AND s.assignment_id = #{assignmentId}
            </if>
            <if test="studentUserId != null">
                AND s.student_user_id = #{studentUserId}
            </if>
            <if test="status != null">
                AND s.status = #{status}
            </if>
            <if test="studentName != null and studentName != ''">
                AND (
                    u.real_name LIKE CONCAT('%', #{studentName}, '%')
                    OR u.username LIKE CONCAT('%', #{studentName}, '%')
                )
            </if>
            <if test="params != null and params.beginSubmitTime != null">
                AND s.submit_time &gt;= #{params.beginSubmitTime}
            </if>
            <if test="params != null and params.endSubmitTime != null">
                AND s.submit_time &lt;= #{params.endSubmitTime}
            </if>
        </where>
        ORDER BY s.submit_time DESC, s.id DESC
    </select>

    <select id="selectAssignmentSubmissionById" parameterType="long" resultMap="AssignmentSubmissionResult">
        SELECT
            s.id,
            s.assignment_id,
            s.student_user_id,
            s.status,
            s.score,
            s.feedback,
            s.submit_time,
            s.grade_time,
            s.graded_by,
            s.content,
            s.create_time,
            s.update_time,
            s.file_name,
            s.file_path,
            s.is_deleted,
            s.delete_time,
            u.real_name AS student_name,
            u.username AS student_username,
            grader.real_name AS graded_by_name
        FROM assignment_submission s
                 LEFT JOIN `user` u ON s.student_user_id = u.id
                 LEFT JOIN `user` grader ON s.graded_by = grader.id
        WHERE s.is_deleted = 0
          AND s.id = #{id}
        LIMIT 1
    </select>

    <update id="updateAssignmentSubmission"
            parameterType="com.ruoyi.system.domain.AssignmentSubmission">
        UPDATE assignment_submission
        <set>
            <if test="score != null">score = #{score},</if>
            <if test="feedback != null">feedback = #{feedback},</if>
            <if test="status != null">status = #{status},</if>
            <if test="gradeTime != null">grade_time = #{gradeTime},</if>
            <if test="gradedBy != null">graded_by = #{gradedBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </set>
        WHERE id = #{id}
    </update>

</mapper>
