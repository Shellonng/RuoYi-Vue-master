<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.KnowledgePointMapper">

    <resultMap type="KnowledgePoint" id="KnowledgePointResult">
        <result property="id"               column="id"               />
        <result property="courseId"         column="course_id"        />
        <result property="title"            column="title"            />
        <result property="description"      column="description"      />
        <result property="level"            column="level"            />
        <result property="creatorUserId"    column="creator_user_id"  />
        <result property="createTime"       column="create_time"      />
        <result property="updateTime"       column="update_time"      />
        <result property="isDeleted"        column="is_deleted"       />
        <result property="deleteTime"       column="delete_time"      />
    </resultMap>

    <sql id="selectKnowledgePointVo">
        select id, course_id, title, description, level, creator_user_id,
               create_time, update_time, is_deleted, delete_time
        from knowledge_point
    </sql>

    <select id="selectKnowledgePointById" parameterType="Long" resultMap="KnowledgePointResult">
        <include refid="selectKnowledgePointVo"/>
        where id = #{id} and is_deleted = 0
    </select>

    <select id="selectKnowledgePointList" parameterType="KnowledgePoint" resultMap="KnowledgePointResult">
        <choose>
            <!-- 如果指定了 sectionId，需要通过 section_kp 关联表查询 -->
            <when test="sectionId != null">
                select kp.id, kp.course_id, kp.title, kp.description, kp.level, kp.creator_user_id,
                       kp.create_time, kp.update_time, kp.is_deleted, kp.delete_time
                from knowledge_point kp
                inner join section_kp skp on kp.id = skp.kp_id
                <where>
                    kp.is_deleted = 0
                    AND skp.section_id = #{sectionId}
                    <if test="courseId != null">
                        AND kp.course_id = #{courseId}
                    </if>
                    <if test="title != null and title != ''">
                        AND kp.title like concat('%', #{title}, '%')
                    </if>
                    <if test="level != null and level != ''">
                        AND kp.level = #{level}
                    </if>
                    <if test="creatorUserId != null">
                        AND kp.creator_user_id = #{creatorUserId}
                    </if>
                </where>
                order by kp.create_time desc
            </when>
            <!-- 否则直接查询 knowledge_point 表 -->
            <otherwise>
                <include refid="selectKnowledgePointVo"/>
                <where>
                    is_deleted = 0
                    <if test="courseId != null">
                        AND course_id = #{courseId}
                    </if>
                    <if test="title != null and title != ''">
                        AND title like concat('%', #{title}, '%')
                    </if>
                    <if test="level != null and level != ''">
                        AND level = #{level}
                    </if>
                    <if test="creatorUserId != null">
                        AND creator_user_id = #{creatorUserId}
                    </if>
                </where>
                order by create_time desc
            </otherwise>
        </choose>
    </select>

    <select id="selectKnowledgePointListByCourseId" parameterType="Long" resultMap="KnowledgePointResult">
        <include refid="selectKnowledgePointVo"/>
        where course_id = #{courseId} and is_deleted = 0
        order by create_time desc
    </select>

    <select id="selectKnowledgePointListByCourseIdAndLevel" resultMap="KnowledgePointResult">
        <include refid="selectKnowledgePointVo"/>
        where course_id = #{courseId} and level = #{level} and is_deleted = 0
        order by create_time desc
    </select>

    <insert id="insertKnowledgePoint" parameterType="KnowledgePoint" useGeneratedKeys="true" keyProperty="id">
        insert into knowledge_point (
            <if test="courseId != null">course_id, </if>
            <if test="title != null and title != ''">title, </if>
            <if test="description != null">description, </if>
            <if test="level != null and level != ''">level, </if>
            <if test="creatorUserId != null">creator_user_id, </if>
            create_time,
            is_deleted
        )values(
            <if test="courseId != null">#{courseId}, </if>
            <if test="title != null and title != ''">#{title}, </if>
            <if test="description != null">#{description}, </if>
            <if test="level != null and level != ''">#{level}, </if>
            <if test="creatorUserId != null">#{creatorUserId}, </if>
            sysdate(),
            0
        )
    </insert>

    <update id="updateKnowledgePoint" parameterType="KnowledgePoint">
        update knowledge_point
        <set>
            <if test="title != null and title != ''">title = #{title}, </if>
            <if test="description != null">description = #{description}, </if>
            <if test="level != null and level != ''">level = #{level}, </if>
            update_time = sysdate()
        </set>
        where id = #{id} and is_deleted = 0
    </update>

    <delete id="deleteKnowledgePointById" parameterType="Long">
        update knowledge_point set is_deleted = 1, delete_time = sysdate() where id = #{id}
    </delete>

    <delete id="deleteKnowledgePointByIds" parameterType="Long">
        update knowledge_point set is_deleted = 1, delete_time = sysdate() where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 批量插入知识点（用于AI生成课程结构） -->
    <insert id="batchInsertKnowledgePoints" parameterType="java.util.List" useGeneratedKeys="true" keyProperty="id">
        insert into knowledge_point (course_id, title, description, level, creator_user_id, create_time, is_deleted)
        values
        <foreach collection="list" item="item" separator=",">
            (#{item.courseId}, #{item.title}, #{item.description}, #{item.level}, #{item.creatorUserId}, sysdate(), 0)
        </foreach>
    </insert>

    <!-- 统计知识点错误次数 -->
    <select id="selectKnowledgePointErrorStats" resultType="com.ruoyi.system.domain.vo.KnowledgePointErrorStats">
        SELECT 
            kp.id AS knowledgePointId,
            kp.title AS knowledgePointName,
            COUNT(*) AS errorCount
        FROM student_answer sa
        INNER JOIN question q ON sa.question_id = q.id
        INNER JOIN knowledge_point kp ON q.knowledge_point = kp.id
        WHERE sa.is_correct = 0
        AND sa.is_deleted = 0
        AND q.is_deleted = 0
        AND kp.is_deleted = 0
        <if test="courseId != null">
            AND kp.course_id = #{courseId}
        </if>
        <choose>
            <when test="targetDate != null and targetDate != ''">
                <!-- 如果指定了日期，查询该日期当天的数据 -->
                AND DATE(sa.answer_time) = #{targetDate}
            </when>
            <otherwise>
                <!-- 未指定日期时，查询最近30天的数据 -->
                AND sa.answer_time >= DATE_SUB(NOW(), INTERVAL 30 DAY)
            </otherwise>
        </choose>
        GROUP BY kp.id, kp.title
        ORDER BY errorCount DESC
        LIMIT 50
    </select>

</mapper>
