<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WebSocket æµ‹è¯•å·¥å…·</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .container {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      background: #f9f9f9;
    }
    .input-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      padding: 10px 20px;
      margin-right: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-primary { background: #409eff; color: white; }
    .btn-success { background: #67c23a; color: white; }
    .btn-danger { background: #f56c6c; color: white; }
    .btn-primary:hover { background: #66b1ff; }
    .btn-success:hover { background: #85ce61; }
    .btn-danger:hover { background: #f78989; }
    .status {
      padding: 10px;
      margin: 15px 0;
      border-radius: 4px;
      font-weight: bold;
    }
    .status.connected { background: #f0f9ff; color: #409eff; }
    .status.disconnected { background: #fef0f0; color: #f56c6c; }
    .messages {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
    }
    .message {
      padding: 8px;
      margin: 5px 0;
      border-left: 3px solid #409eff;
      background: #f0f9ff;
    }
    .message.sent {
      border-left-color: #67c23a;
      background: #f0f9ff;
    }
    .message.received {
      border-left-color: #409eff;
      background: #ecf5ff;
    }
    .message.error {
      border-left-color: #f56c6c;
      background: #fef0f0;
    }
    .timestamp {
      font-size: 12px;
      color: #909399;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1>ğŸ”Œ WebSocket æµ‹è¯•å·¥å…·</h1>
  <p>ç”¨äºæµ‹è¯• AI æ™ºèƒ½ç»„å· WebSocket è¿æ¥</p>

  <div class="container">
    <div class="input-group">
      <label>WebSocket URL:</label>
      <input type="text" id="wsUrl" value="ws://localhost:8001/ws/workflow/conversations/test-conv-id/messages">
    </div>

    <div class="input-group">
      <label>Conversation ID:</label>
      <input type="text" id="convId" value="test-conv-id">
    </div>

    <div class="status" id="status" class="disconnected">
      âš« æœªè¿æ¥
    </div>

    <div>
      <button class="btn-primary" onclick="connect()">ğŸ”Œ è¿æ¥</button>
      <button class="btn-danger" onclick="disconnect()">âŒ æ–­å¼€</button>
      <button class="btn-success" onclick="clearMessages()">ğŸ—‘ï¸ æ¸…ç©ºæ¶ˆæ¯</button>
    </div>

    <div class="input-group" style="margin-top: 20px;">
      <label>å‘é€æ¶ˆæ¯:</label>
      <textarea id="message" rows="3" placeholder='{"message": "æˆ‘éœ€è¦ä¸€ä»½ç¥ç»ç½‘ç»œæµ‹è¯•"}'>{"message": "æˆ‘éœ€è¦ä¸€ä»½ç¥ç»ç½‘ç»œæµ‹è¯•ï¼Œéš¾åº¦3"}</textarea>
      <button class="btn-success" style="margin-top: 10px;" onclick="sendMessage()">ğŸ“¤ å‘é€</button>
    </div>

    <div class="messages" id="messages">
      <p style="color: #909399;">ç­‰å¾…æ¶ˆæ¯...</p>
    </div>
  </div>

  <script>
    let ws = null;

    function connect() {
      const url = document.getElementById('wsUrl').value;
      const status = document.getElementById('status');
      
      try {
        ws = new WebSocket(url);
        
        ws.onopen = () => {
          status.className = 'status connected';
          status.innerHTML = 'ğŸŸ¢ å·²è¿æ¥';
          addMessage('ç³»ç»Ÿ', 'âœ… WebSocket è¿æ¥æˆåŠŸ', 'received');
        };
        
        ws.onmessage = (event) => {
          addMessage('æœåŠ¡å™¨', event.data, 'received');
          
          // å°è¯•è§£æ JSON
          try {
            const data = JSON.parse(event.data);
            console.log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯:', data);
            
            // æ˜¾ç¤ºè§£æåçš„ç»“æ„
            const formatted = JSON.stringify(data, null, 2);
            addMessage('è§£æç»“æœ', `<pre style="margin:0">${formatted}</pre>`, 'received');
          } catch (e) {
            console.log('ğŸ“¨ æ”¶åˆ°çº¯æ–‡æœ¬:', event.data);
          }
        };
        
        ws.onerror = (error) => {
          console.error('âŒ WebSocket é”™è¯¯:', error);
          addMessage('é”™è¯¯', 'è¿æ¥é”™è¯¯', 'error');
        };
        
        ws.onclose = (event) => {
          status.className = 'status disconnected';
          status.innerHTML = 'âš« å·²æ–­å¼€';
          addMessage('ç³»ç»Ÿ', `ğŸ”Œ è¿æ¥å…³é—­ (code: ${event.code})`, 'error');
          ws = null;
        };
      } catch (error) {
        addMessage('é”™è¯¯', error.message, 'error');
      }
    }

    function disconnect() {
      if (ws) {
        ws.close(1000, 'User closed');
        ws = null;
      }
    }

    function sendMessage() {
      const messageInput = document.getElementById('message');
      const message = messageInput.value.trim();
      
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert('WebSocket æœªè¿æ¥ï¼');
        return;
      }
      
      try {
        ws.send(message);
        addMessage('å®¢æˆ·ç«¯', message, 'sent');
        console.log('ğŸ“¤ å‘é€æ¶ˆæ¯:', message);
      } catch (error) {
        addMessage('é”™è¯¯', error.message, 'error');
      }
    }

    function addMessage(from, content, type = 'received') {
      const messagesDiv = document.getElementById('messages');
      if (messagesDiv.children[0]?.textContent === 'ç­‰å¾…æ¶ˆæ¯...') {
        messagesDiv.innerHTML = '';
      }
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      const timestamp = new Date().toLocaleTimeString();
      messageDiv.innerHTML = `<strong>${from}</strong><span class="timestamp">${timestamp}</span><br>${content}`;
      
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function clearMessages() {
      document.getElementById('messages').innerHTML = '<p style="color: #909399;">ç­‰å¾…æ¶ˆæ¯...</p>';
    }

    // å›è½¦å‘é€
    document.getElementById('message').addEventListener('keypress', (e) => {
      if (e.ctrlKey && e.key === 'Enter') {
        sendMessage();
      }
    });
  </script>
</body>
</html>
