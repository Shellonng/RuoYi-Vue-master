# å°èŠ‚è®¨è®ºåŒºåŠŸèƒ½å®ç°æ€»ç»“

## ğŸ“‹ å®ç°æ¦‚è¿°

å·²æˆåŠŸå°†å°èŠ‚è¯¦æƒ…é¡µçš„è®¨è®ºåŒºä»è™šæ‹Ÿæ•°æ®è¿ç§»åˆ°çœŸå®çš„æ•°æ®åº“å®ç°,æ”¯æŒå®Œæ•´çš„è¯„è®ºå’Œå›å¤åŠŸèƒ½ã€‚

## ğŸ—„ï¸ æ•°æ®åº“è¡¨

ä½¿ç”¨ç°æœ‰çš„ `section_comment` è¡¨:
- **ä¸»è¦å­—æ®µ**: id, section_id, user_id, content, parent_id, create_time
- **æ”¯æŒåŠŸèƒ½**: ä¸€çº§è¯„è®ºå’ŒäºŒçº§å›å¤(é€šè¿‡ parent_id å®ç°)
- **ç”¨æˆ·å…³è”**: ä½¿ç”¨ä¸šåŠ¡è¡¨ user.id (é€šè¿‡ BusinessUserUtils è·å–)

## ğŸ”§ åç«¯å®ç°

### 1. å®ä½“ç±» (Domain)
**æ–‡ä»¶**: `ruoyi-system/src/main/java/com/ruoyi/system/domain/SectionComment.java`

åŒ…å«åŸºæœ¬å­—æ®µå’Œæ‰©å±•å­—æ®µ:
- åŸºæœ¬å­—æ®µ: id, sectionId, userId, content, parentId, createTime
- æ‰©å±•å­—æ®µ: userName, userAvatar, userRole, replyCount, replies (ç”¨äºå‰ç«¯å±•ç¤º)

### 2. æ•°æ®è®¿é—®å±‚ (Mapper)
**æ¥å£**: `ruoyi-system/src/main/java/com/ruoyi/system/mapper/SectionCommentMapper.java`
**XML**: `ruoyi-system/src/main/resources/mapper/system/SectionCommentMapper.xml`

æ ¸å¿ƒæ–¹æ³•:
- `selectTopCommentsBySectionId()` - æŸ¥è¯¢ä¸€çº§è¯„è®º(å«ç”¨æˆ·ä¿¡æ¯å’Œå›å¤æ•°)
- `selectRepliesByParentId()` - æŸ¥è¯¢æŸè¯„è®ºçš„æ‰€æœ‰å›å¤
- `insertSectionComment()` - æ–°å¢è¯„è®º
- `deleteSectionCommentById()` - åˆ é™¤è¯„è®º(é€»è¾‘åˆ é™¤)

### 3. ä¸šåŠ¡å±‚ (Service)
**æ¥å£**: `ruoyi-system/src/main/java/com/ruoyi/system/service/ISectionCommentService.java`
**å®ç°**: `ruoyi-system/src/main/java/com/ruoyi/system/service/impl/SectionCommentServiceImpl.java`

æ ¸å¿ƒæ–¹æ³•:
- `selectCommentTreeBySectionId()` - æŸ¥è¯¢è¯„è®ºæ ‘(ä¸€çº§è¯„è®º+å›å¤åˆ—è¡¨)
- `insertSectionComment()` - æ–°å¢è¯„è®º(è‡ªåŠ¨è®¾ç½®åˆ›å»ºæ—¶é—´)
- `deleteSectionCommentByIds()` - æ‰¹é‡åˆ é™¤

### 4. æ§åˆ¶å™¨ (Controller)
**æ–‡ä»¶**: `ruoyi-admin/src/main/java/com/ruoyi/web/controller/system/SectionCommentController.java`

APIæ¥å£:
- `GET /system/comment/tree/{sectionId}` - è·å–å°èŠ‚è¯„è®ºæ ‘
- `POST /system/comment` - å‘è¡¨è¯„è®º/å›å¤
- `PUT /system/comment` - ä¿®æ”¹è¯„è®º
- `DELETE /system/comment/{ids}` - åˆ é™¤è¯„è®º

**æƒé™éªŒè¯**:
- ä½¿ç”¨ `BusinessUserUtils.getCurrentBusinessUserId()` è·å–å½“å‰ç”¨æˆ·ID
- ä¿®æ”¹/åˆ é™¤æ—¶éªŒè¯æ˜¯å¦ä¸ºè¯„è®ºä½œè€…
- éç®¡ç†å‘˜åªèƒ½åˆ é™¤è‡ªå·±çš„è¯„è®º

## ğŸ¨ å‰ç«¯å®ç°

### 1. APIæ¥å£
**æ–‡ä»¶**: `ruoyi-ui/src/api/system/comment.js`

å°è£…çš„æ¥å£æ–¹æ³•:
- `getCommentTree(sectionId)` - è·å–è¯„è®ºæ ‘
- `addComment(data)` - å‘è¡¨è¯„è®º
- `delComment(ids)` - åˆ é™¤è¯„è®º

### 2. é¡µé¢ç»„ä»¶
**æ–‡ä»¶**: `ruoyi-ui/src/views/course/section.vue`

**æ ¸å¿ƒåŠŸèƒ½**:

#### è¯„è®ºå±•ç¤º
- æ˜¾ç¤ºè¯„è®ºè€…å§“åã€å¤´åƒã€è§’è‰²æ ‡ç­¾(æ•™å¸ˆæ ‡è¯†)
- æ˜¾ç¤ºè¯„è®ºå†…å®¹å’Œå‘è¡¨æ—¶é—´
- æ˜¾ç¤ºå›å¤æ•°é‡
- å±•å¼€æ˜¾ç¤ºæ‰€æœ‰å›å¤

#### å‘è¡¨è¯„è®º
```javascript
postDiscussion() {
  // è°ƒç”¨ addComment API
  // è‡ªåŠ¨å…³è” sectionId å’Œ userId
  // æˆåŠŸååˆ·æ–°åˆ—è¡¨
}
```

#### å›å¤åŠŸèƒ½
```javascript
showReplyInput(item)   // æ˜¾ç¤ºå›å¤è¾“å…¥æ¡†
submitReply(item)       // æäº¤å›å¤(è®¾ç½® parentId)
```

#### åˆ é™¤åŠŸèƒ½
```javascript
deleteDiscussion(commentId)  // äºŒæ¬¡ç¡®è®¤ååˆ é™¤
```

**UIä¼˜åŒ–**:
- å›å¤åˆ—è¡¨ç¼©è¿›æ˜¾ç¤º,å·¦ä¾§æœ‰ç«–çº¿è¿æ¥
- å›å¤è¾“å…¥æ¡†åŠ¨æ€æ˜¾ç¤º/éšè—
- æ•™å¸ˆè¯„è®ºæ˜¾ç¤ºç‰¹æ®Šæ ‡ç­¾
- ç©ºçŠ¶æ€æç¤º

### 3. æ ·å¼å¢å¼º
æ·»åŠ äº†å›å¤åˆ—è¡¨å’Œå›å¤è¾“å…¥æ¡†çš„ä¸“ç”¨æ ·å¼:
- `.replies-list` - å›å¤åˆ—è¡¨å®¹å™¨(å¸¦å·¦ä¾§è¾¹æ¡†)
- `.reply-item` - å•æ¡å›å¤æ ·å¼
- `.reply-input-area` - å›å¤è¾“å…¥æ¡†åŒºåŸŸ

## ğŸ” å…³é”®æŠ€æœ¯ç‚¹

### ç”¨æˆ·IDè·å–
```java
// åç«¯ Controller
Long userId = BusinessUserUtils.getCurrentBusinessUserId();
sectionComment.setUserId(userId);
```

**è¯´æ˜**: 
- Tokenä¸­å­˜å‚¨çš„æ˜¯ `sys_user_id`
- ä¸šåŠ¡è¡¨ä½¿ç”¨ `user.id`
- `BusinessUserUtils` è‡ªåŠ¨å®Œæˆæ˜ å°„è½¬æ¢

### è¯„è®ºæ ‘å½¢ç»“æ„
```java
// Serviceå±‚
List<SectionComment> topComments = mapper.selectTopCommentsBySectionId(sectionId);
for (SectionComment comment : topComments) {
    List<SectionComment> replies = mapper.selectRepliesByParentId(comment.getId());
    comment.setReplies(replies);
}
```

### å‰ç«¯åŠ¨æ€å±æ€§
```javascript
// Vueä¸­ä¸ºå¯¹è±¡æ·»åŠ å“åº”å¼å±æ€§
this.$set(item, 'showReplyInput', true);
this.$set(item, 'replyContent', '');
```

## ğŸ“Š æ•°æ®æµç¨‹

### å‘è¡¨è¯„è®ºæµç¨‹
```
å‰ç«¯è¾“å…¥ â†’ addComment(API) 
â†’ SectionCommentController.add() 
â†’ è‡ªåŠ¨è·å– userId 
â†’ SectionCommentService.insert() 
â†’ ä¿å­˜åˆ°æ•°æ®åº“ 
â†’ è¿”å›æˆåŠŸ 
â†’ åˆ·æ–°è¯„è®ºåˆ—è¡¨
```

### åŠ è½½è¯„è®ºæµç¨‹
```
é¡µé¢åŠ è½½ â†’ loadDiscussions() 
â†’ getCommentTree(API) 
â†’ SectionCommentController.getCommentTree() 
â†’ Service.selectCommentTreeBySectionId() 
â†’ æŸ¥è¯¢ä¸€çº§è¯„è®º + å…³è”å›å¤ + ç”¨æˆ·ä¿¡æ¯ 
â†’ è¿”å›æ ‘å½¢æ•°æ® 
â†’ é¡µé¢æ¸²æŸ“
```

## âœ… åŠŸèƒ½æ¸…å•

- [x] æŸ¥çœ‹å°èŠ‚çš„æ‰€æœ‰è¯„è®º
- [x] å‘è¡¨ä¸€çº§è¯„è®º
- [x] å›å¤è¯„è®º(äºŒçº§è¯„è®º)
- [x] åˆ é™¤è‡ªå·±çš„è¯„è®º
- [x] æ˜¾ç¤ºè¯„è®ºè€…ä¿¡æ¯(å§“åã€å¤´åƒã€è§’è‰²)
- [x] æ˜¾ç¤ºè¯„è®ºæ—¶é—´
- [x] æ˜¾ç¤ºå›å¤æ•°é‡
- [x] å±•å¼€/æ”¶èµ·å›å¤åˆ—è¡¨
- [x] æ•™å¸ˆè§’è‰²æ ‡è¯†
- [x] æƒé™æ§åˆ¶(åªèƒ½åˆ é™¤è‡ªå·±çš„è¯„è®º)

## ğŸš€ æµ‹è¯•å»ºè®®

1. **åŸºç¡€åŠŸèƒ½æµ‹è¯•**
   - å‘è¡¨è¯„è®º
   - å›å¤è¯„è®º
   - åˆ é™¤è¯„è®º

2. **æƒé™æµ‹è¯•**
   - å­¦ç”Ÿè§’è‰²åªèƒ½åˆ é™¤è‡ªå·±çš„è¯„è®º
   - æ•™å¸ˆè¯„è®ºæ˜¾ç¤ºç‰¹æ®Šæ ‡ç­¾

3. **è¾¹ç•Œæµ‹è¯•**
   - ç©ºå†…å®¹æäº¤
   - é•¿æ–‡æœ¬è¯„è®º
   - æ— è¯„è®ºçŠ¶æ€æ˜¾ç¤º

4. **ç”¨æˆ·ä½“éªŒæµ‹è¯•**
   - è¯„è®ºå®æ—¶åˆ·æ–°
   - å›å¤å±•å¼€äº¤äº’
   - åŠ è½½çŠ¶æ€æç¤º

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç”¨æˆ·IDæ˜ å°„**: ç¡®ä¿ BusinessUserUtils æ­£ç¡®é…ç½®å¹¶èƒ½è·å–åˆ° user.id
2. **é€»è¾‘åˆ é™¤**: è¯„è®ºé‡‡ç”¨é€»è¾‘åˆ é™¤(is_deleted=1),ä¸ç‰©ç†åˆ é™¤
3. **çº§è”åˆ é™¤**: åˆ é™¤ä¸€çº§è¯„è®ºæ—¶,æ•°æ®åº“å¤–é”®ä¼šè‡ªåŠ¨å¤„ç†å­å›å¤
4. **æ€§èƒ½ä¼˜åŒ–**: å¤§é‡è¯„è®ºæ—¶å¯è€ƒè™‘åˆ†é¡µåŠ è½½
5. **å®‰å…¨æ€§**: Controllerå±‚åšäº†æƒé™éªŒè¯,é˜²æ­¢è¶Šæƒæ“ä½œ

## ğŸ”„ åç»­ä¼˜åŒ–æ–¹å‘

- [ ] è¯„è®ºåˆ†é¡µåŠ è½½
- [ ] ç‚¹èµåŠŸèƒ½å®ç°
- [ ] è¯„è®ºæ’åº(æœ€æ–°/æœ€çƒ­)
- [ ] @æåŠåŠŸèƒ½
- [ ] è¯„è®ºæœç´¢
- [ ] å¯Œæ–‡æœ¬æ”¯æŒ
- [ ] è¡¨æƒ…åŒ…æ”¯æŒ
- [ ] è¯„è®ºä¸¾æŠ¥

## ğŸ“ ç›¸å…³æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶
```
ruoyi-system/
â”œâ”€â”€ domain/SectionComment.java
â”œâ”€â”€ mapper/SectionCommentMapper.java
â”œâ”€â”€ mapper/xml/SectionCommentMapper.xml
â”œâ”€â”€ service/ISectionCommentService.java
â””â”€â”€ service/impl/SectionCommentServiceImpl.java

ruoyi-admin/
â””â”€â”€ controller/system/SectionCommentController.java
```

### å‰ç«¯æ–‡ä»¶
```
ruoyi-ui/src/
â”œâ”€â”€ api/system/comment.js
â””â”€â”€ views/course/section.vue (å·²ä¿®æ”¹)
```

---

**å®ç°æ—¥æœŸ**: 2025å¹´11æœˆ22æ—¥
**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡
