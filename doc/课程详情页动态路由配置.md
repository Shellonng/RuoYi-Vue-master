# 课程详情页路由配置方案

## 问题描述

使用静态路由配置（在 `router/index.js` 中手动添加）会导致两个问题：

1. **不符合若依框架的设计模式** - 菜单和路由应该从数据库动态加载
2. **页面不在框架布局内** - 配置 `hidden: true` 的路由会脱离侧边栏上下文

## 解决方案对比

### ❌ 方案A：静态路由配置（不推荐）

```javascript
// router/index.js
{
  path: '/course',
  component: Layout,
  hidden: true,  // 完全隐藏，脱离框架布局
  children: [
    {
      path: 'detail/:id',
      component: () => import('@/views/course/detail')
    }
  ]
}
```

**问题：**
- 页面没有侧边栏和顶部导航
- 不符合框架的动态路由设计
- 需要手动维护路由代码

---

### ✅ 方案B：数据库动态路由（推荐）

将详情页配置为**课程管理的隐藏子菜单**，存储在数据库中。

## 实施步骤

### 第一步：查询课程管理的菜单ID

```sql
SELECT menu_id, menu_name, path FROM sys_menu WHERE menu_name = '课程管理';
```

假设查询结果：
```
menu_id | menu_name  | path
--------|------------|-------
2000    | 课程管理    | course
```

记住这个 `menu_id = 2000`，下一步会用到。

---

### 第二步：插入课程详情页菜单

```sql
INSERT INTO sys_menu (
    menu_name,
    parent_id,      -- 课程管理的 menu_id
    order_num,
    path,
    component,
    is_frame,
    is_cache,
    menu_type,
    visible,        -- '1' 表示隐藏
    status,
    perms,
    icon,
    create_by,
    create_time
) VALUES (
    '课程详情',
    2000,            -- 改成实际的课程管理菜单ID
    2,
    'detail/:id',    -- 动态参数路由
    'course/detail', -- 组件路径
    1,
    0,
    'C',
    '1',             -- ★ 关键：隐藏不在侧边栏显示
    '0',
    'course:course:query',
    '',
    'admin',
    NOW()
);
```

**关键字段说明：**

| 字段 | 值 | 说明 |
|-----|---|------|
| `parent_id` | `2000` | 父菜单ID，课程管理的menu_id |
| `path` | `detail/:id` | 相对路径，拼接后为 `/course/detail/:id` |
| `component` | `course/detail` | 组件路径，对应 `@/views/course/detail.vue` |
| `visible` | `'1'` | **隐藏菜单**，不在侧边栏显示 |
| `menu_type` | `'C'` | 菜单类型（M目录/C菜单/F按钮） |

---

### 第三步：删除静态路由配置

打开 [ruoyi-ui/src/router/index.js](../ruoyi-ui/src/router/index.js)，删除之前手动添加的路由：

```javascript
// ❌ 删除这段静态配置
{
  path: '/course',
  component: Layout,
  hidden: true,
  redirect: 'noredirect',
  children: [
    {
      path: 'detail/:id',
      component: () => import('@/views/course/detail'),
      name: 'CourseDetail',
      meta: { title: '课程详情', icon: 'education', activeMenu: '/course' }
    }
  ]
}
```

---

### 第四步：前端代码保持不变

[ruoyi-ui/src/views/course/index.vue](../ruoyi-ui/src/views/course/index.vue) 中的跳转代码**不需要修改**：

```javascript
handleView(row) {
  this.$router.push({
    path: '/course/detail/' + row.id
  });
}
```

或使用命名路由（需要设置菜单的 `name` 字段）：

```javascript
handleView(row) {
  this.$router.push({
    name: 'CourseDetail',
    params: { id: row.id }
  });
}
```

---

### 第五步：验证配置

1. **重启后端服务**（加载新的菜单数据）
2. **清除浏览器缓存，重新登录**
3. 打开浏览器控制台，查看动态加载的路由：

```javascript
console.log(this.$router.options.routes)
```

应该能看到类似的路由结构：

```javascript
{
  path: "/course",
  component: Layout,
  children: [
    {
      path: "index",
      component: () => import('@/views/course/index'),
      meta: { title: "课程管理", icon: "education" }
    },
    {
      path: "detail/:id",  // 动态路由
      component: () => import('@/views/course/detail'),
      meta: { title: "课程详情", activeMenu: '/course' },
      hidden: true  // 系统自动添加
    }
  ]
}
```

4. **测试跳转**：
   - 点击课程卡片或"查看详情"按钮
   - 页面应该在框架布局内显示（保留侧边栏和顶部导航）
   - URL 应该是 `http://localhost/course/detail/1`
   - 左侧菜单"课程管理"应该保持高亮状态

---

## 核心原理

### 数据库配置如何生成路由？

**后端处理流程：**

1. 用户登录后，后端从 `sys_menu` 表查询该用户有权限的菜单：

```java
// MenuServiceImpl.java
public List<SysMenu> selectMenuTreeByUserId(Long userId) {
    List<SysMenu> menus = menuMapper.selectMenuTreeByUserId(userId);
    return getChildPerms(menus, 0);
}
```

2. 构建树形结构，返回给前端：

```json
{
  "code": 200,
  "data": [
    {
      "path": "/course",
      "component": "Layout",
      "name": "Course",
      "meta": { "title": "课程管理", "icon": "education" },
      "children": [
        {
          "path": "index",
          "component": "course/index",
          "name": "CourseIndex",
          "meta": { "title": "课程管理" }
        },
        {
          "path": "detail/:id",
          "component": "course/detail",
          "name": "CourseDetail",
          "meta": { "title": "课程详情" },
          "hidden": true  // visible='1' 转换为 hidden=true
        }
      ]
    }
  ]
}
```

**前端处理流程：**

[ruoyi-ui/src/store/modules/permission.js](../ruoyi-ui/src/store/modules/permission.js):

```javascript
actions: {
  GenerateRoutes({ commit }) {
    return new Promise(resolve => {
      getRouters().then(res => {
        const sidebarRoutes = filterAsyncRouter(res.data)

        // 转换组件路径
        function filterAsyncRouter(asyncRouterMap) {
          return asyncRouterMap.filter(route => {
            if (route.component === 'Layout') {
              route.component = Layout  // 字符串 → 组件对象
            } else {
              route.component = loadView(route.component)  // 懒加载
            }

            // 递归处理子路由
            if (route.children && route.children.length) {
              route.children = filterAsyncRouter(route.children)
            }

            return true
          })
        }

        commit('SET_SIDEBAR_ROUTERS', sidebarRoutes)
        router.addRoutes(sidebarRoutes)  // 动态添加路由
      })
    })
  }
}
```

---

## 关键配置对比

### visible 字段的作用

| visible | 前端转换 | 侧边栏显示 | 路由可访问 | 使用场景 |
|---------|---------|-----------|-----------|---------|
| `'0'` | `hidden: false` | ✅ 显示 | ✅ 可访问 | 正常菜单项 |
| `'1'` | `hidden: true` | ❌ 隐藏 | ✅ 可访问 | 详情页、编辑页等 |

**示例：**

```sql
-- 课程管理（显示在侧边栏）
INSERT INTO sys_menu (menu_name, visible, path, component)
VALUES ('课程管理', '0', 'course', 'course/index');

-- 课程详情（隐藏，但可以通过代码跳转访问）
INSERT INTO sys_menu (menu_name, visible, path, component, parent_id)
VALUES ('课程详情', '1', 'detail/:id', 'course/detail', 2000);
```

### activeMenu 的作用

在详情页中，希望左侧菜单仍然高亮"课程管理"：

**数据库配置方式：**
- 若依框架会自动处理，因为详情页是课程管理的子菜单

**静态路由配置方式：**
```javascript
meta: {
  title: '课程详情',
  activeMenu: '/course'  // 手动指定高亮菜单
}
```

---

## 完整示例

### 数据库配置

```sql
-- 1. 课程管理（父菜单，显示在侧边栏）
INSERT INTO sys_menu (
    menu_id, menu_name, parent_id, order_num, path, component,
    menu_type, visible, status, perms, icon
) VALUES (
    2000, '课程管理', 0, 1, 'course', 'course/index',
    'C', '0', '0', 'course:course:list', 'education'
);

-- 2. 课程详情（子菜单，隐藏）
INSERT INTO sys_menu (
    menu_id, menu_name, parent_id, order_num, path, component,
    menu_type, visible, status, perms, icon
) VALUES (
    2001, '课程详情', 2000, 2, 'detail/:id', 'course/detail',
    'C', '1', '0', 'course:course:query', ''
);
```

### 生成的路由结构

```javascript
{
  path: "/course",
  component: Layout,
  redirect: "noredirect",
  children: [
    {
      path: "index",
      component: () => import('@/views/course/index'),
      name: "CourseIndex",
      meta: { title: "课程管理", icon: "education" }
    },
    {
      path: "detail/:id",
      component: () => import('@/views/course/detail'),
      name: "CourseDetail",
      meta: { title: "课程详情" },
      hidden: true
    }
  ]
}
```

### 页面跳转代码

```javascript
// 方式1：路径跳转
this.$router.push('/course/detail/' + row.id)

// 方式2：命名路由（推荐）
this.$router.push({
  name: 'CourseDetail',
  params: { id: row.id }
})
```

### 详情页获取参数

```javascript
// detail.vue
export default {
  created() {
    // 获取路由参数
    const courseId = this.$route.params.id
    this.getCourseInfo(courseId)
  }
}
```

---

## 优势对比

| 特性 | 静态路由配置 | 数据库动态路由 |
|-----|------------|--------------|
| 配置位置 | `router/index.js` 代码 | `sys_menu` 数据库表 |
| 修改方式 | 改代码，重新打包 | 改数据库，无需打包 |
| 权限控制 | 需要手动实现 | 框架自动处理 |
| 侧边栏显示 | 需要手动配置 | 自动根据 `visible` 字段 |
| 菜单高亮 | 需要配置 `activeMenu` | 自动处理父子关系 |
| 框架布局 | 容易配置错误 | 自动保持布局 |
| 团队协作 | 需要同步代码 | 同步数据库即可 |

---

## 常见问题

### Q1：为什么要设置 `visible='1'`？
**A：** `visible='1'` 表示隐藏菜单，不在侧边栏显示，但路由仍然可以访问。详情页、编辑页等辅助页面都应该设置为隐藏。

### Q2：如何确保页面在框架布局内？
**A：** 关键是 `parent_id` 设置正确，让详情页成为课程管理的子菜单。框架会自动将其渲染在 Layout 组件内。

### Q3：点击详情页后，左侧菜单会高亮吗？
**A：** 会的。若依框架会自动根据父子菜单关系，在访问详情页时高亮父菜单"课程管理"。

### Q4：需要删除静态路由配置吗？
**A：** 是的。数据库配置和静态配置不要混用，否则会产生冲突。使用数据库配置后，删除 `router/index.js` 中的手动配置。

### Q5：动态路由参数 `:id` 如何传递？
**A：**
- 跳转时：`this.$router.push('/course/detail/' + row.id)`
- 接收时：`this.$route.params.id`

---

## 测试清单

完成配置后，按以下步骤测试：

- [ ] 执行 SQL 脚本，插入课程详情菜单
- [ ] 验证数据库中 `parent_id` 和 `visible` 字段正确
- [ ] 删除 `router/index.js` 中的静态路由配置
- [ ] 重启后端服务
- [ ] 清除浏览器缓存，重新登录
- [ ] 左侧菜单**不显示**"课程详情"项
- [ ] 点击"查看详情"按钮，能正常跳转
- [ ] 详情页**保留**左侧菜单和顶部导航
- [ ] 左侧"课程管理"菜单保持高亮状态
- [ ] URL 显示为 `/course/detail/1`
- [ ] 刷新页面，详情页正常显示
- [ ] 浏览器控制台无错误信息

---

## 总结

使用数据库动态路由配置的核心要点：

1. **在 `sys_menu` 表中添加详情页菜单记录**
2. **设置 `parent_id` 为课程管理的菜单ID**
3. **设置 `visible='1'` 隐藏侧边栏显示**
4. **删除 `router/index.js` 中的静态配置**
5. **前端跳转代码保持不变**

这样配置后，详情页会：
- ✅ 在框架布局内显示（保留侧边栏和导航栏）
- ✅ 不在侧边栏显示菜单项
- ✅ 通过代码跳转可以访问
- ✅ 父菜单"课程管理"保持高亮
- ✅ 符合若依框架的设计模式

---

## 相关文档

- [菜单点击页面切换原理.md](./菜单点击页面切换原理.md)
- [课程详情页面实现.md](./课程详情页面实现.md)
- [若依框架菜单管理文档](http://doc.ruoyi.vip/ruoyi-vue/document/qlsc.html#%E8%8F%9C%E5%8D%95%E7%AE%A1%E7%90%86)
