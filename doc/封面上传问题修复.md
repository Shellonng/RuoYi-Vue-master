# 课程封面上传问题修复

## 问题描述

上传课程封面后点击确认提交时出现数据库错误：

```
Error updating database. Cause: com.mysql.cj.jdbc.exceptions.MysqlDataTruncation:
Data truncation: Data too long for column 'cover_image' at row 1
```

## 问题原因

原来的实现使用 `FileReader.readAsDataURL()` 将图片转换为 base64 编码存储在数据库中。base64 编码会将图片数据转换为非常长的字符串（通常是原文件大小的 1.33 倍），即使是小图片也会产生数万字符的字符串，远超数据库字段 `cover_image VARCHAR(500)` 的限制。

**原代码问题：**
```javascript
handleCoverUpload(params) {
  const file = params.file;
  const reader = new FileReader();
  reader.onload = (e) => {
    this.form.coverImage = e.target.result;  // 存储base64，数据量巨大
  };
  reader.readAsDataURL(file);
}
```

## 解决方案

使用若依框架自带的文件上传功能，将图片文件上传到服务器，数据库只存储文件路径（相对路径），而不是图片数据本身。

### 修改内容

#### 1. 修改上传组件配置

**修改前：**
```vue
<el-upload
  class="cover-uploader"
  action="#"
  :show-file-list="false"
  :before-upload="beforeCoverUpload"
  :http-request="handleCoverUpload"
>
  <img v-if="form.coverImage" :src="form.coverImage" class="cover-preview">
  <i v-else class="el-icon-plus cover-uploader-icon"></i>
</el-upload>
```

**修改后：**
```vue
<el-upload
  class="cover-uploader"
  :action="uploadAction"
  :headers="uploadHeaders"
  :show-file-list="false"
  :on-success="handleCoverSuccess"
  :before-upload="beforeCoverUpload"
>
  <img v-if="form.coverImage" :src="getCoverUrl(form.coverImage)" class="cover-preview">
  <i v-else class="el-icon-plus cover-uploader-icon"></i>
</el-upload>
```

#### 2. 添加上传配置

```javascript
data() {
  return {
    // 上传配置
    uploadAction: process.env.VUE_APP_BASE_API + "/common/upload",
    uploadHeaders: { Authorization: "Bearer " + getToken() },
    // ... 其他配置
  }
}
```

#### 3. 修改上传处理方法

**删除旧方法：**
```javascript
handleCoverUpload(params) {
  const file = params.file;
  const reader = new FileReader();
  reader.onload = (e) => {
    this.form.coverImage = e.target.result;  // base64，过大
  };
  reader.readAsDataURL(file);
  this.$message.success('封面上传成功');
}
```

**新增方法：**
```javascript
/** 上传成功回调 */
handleCoverSuccess(response, file) {
  if (response.code === 200) {
    this.form.coverImage = response.fileName;  // 只存储文件路径
    this.$message.success('封面上传成功');
  } else {
    this.$message.error(response.msg || '上传失败');
  }
},

/** 获取封面完整URL */
getCoverUrl(coverImage) {
  if (!coverImage) {
    return this.getDefaultCover();
  }
  // 如果已经是完整URL，直接返回
  if (coverImage.startsWith('http://') || coverImage.startsWith('https://')) {
    return coverImage;
  }
  // 如果是base64，直接返回（兼容旧数据）
  if (coverImage.startsWith('data:image')) {
    return coverImage;
  }
  // 否则拼接服务器地址
  return process.env.VUE_APP_BASE_API + coverImage;
}
```

#### 4. 修改显示逻辑

**卡片视图：**
```vue
<div class="course-cover" :style="{ backgroundImage: `url(${getCoverUrl(course.coverImage)})` }">
```

## 工作原理

### 上传流程

1. **用户选择图片** → 触发 `beforeCoverUpload` 验证（格式、大小）
2. **上传到服务器** → Element UI 自动调用 `/common/upload` 接口
3. **服务器处理** → `CommonController.uploadFile()` 方法：
   - 保存文件到服务器磁盘（默认路径：`/profile/upload/`）
   - 返回文件路径，如：`/profile/upload/2024/01/20/xxx.jpg`
4. **前端接收** → `handleCoverSuccess` 回调：
   - 将文件路径保存到 `form.coverImage`
   - 提交表单时只存储路径字符串到数据库
5. **显示图片** → `getCoverUrl` 方法：
   - 拼接完整URL：`http://localhost:8080/profile/upload/2024/01/20/xxx.jpg`
   - 浏览器加载显示

### 数据库存储对比

| 存储方式 | 数据示例 | 字符长度 | 优缺点 |
|---------|---------|---------|--------|
| **base64编码** | `data:image/jpeg;base64,/9j/4AAQSkZJRg...` | 10000+ | ❌ 数据量大<br>❌ 数据库膨胀<br>❌ 传输慢 |
| **文件路径** | `/profile/upload/2024/01/20/abc123.jpg` | 40-80 | ✅ 占用空间小<br>✅ 性能好<br>✅ 易于管理 |

## 优势

1. **数据库性能优化** - 数据库只存储短字符串路径，查询和更新速度快
2. **文件管理规范** - 文件集中存储在服务器磁盘，便于备份和管理
3. **网络传输优化** - 浏览器直接请求图片文件，支持缓存，加载速度快
4. **可扩展性好** - 可以轻松对接 OSS、CDN 等云存储服务

## 注意事项

1. **服务器存储路径配置**
   - 确保 `RuoYiConfig.getUploadPath()` 配置正确
   - 默认路径通常在 `application.yml` 中配置

2. **文件访问权限**
   - 确保上传目录有写权限
   - 确保静态资源映射配置正确，浏览器能访问上传的文件

3. **兼容性处理**
   - `getCoverUrl` 方法兼容多种格式（完整URL、相对路径、base64）
   - 支持旧数据平滑迁移

## 相关文件

- **前端组件**：`ruoyi-ui/src/views/course/index.vue`
- **API封装**：`ruoyi-ui/src/api/course/course.js`
- **后端Controller**：`ruoyi-admin/src/main/java/com/ruoyi/web/controller/common/CommonController.java`
- **后端实体类**：`ruoyi-system/src/main/java/com/ruoyi/system/domain/Course.java`

## 测试步骤

1. 启动后端服务
2. 前端执行 `npm run dev`
3. 登录系统，进入课程管理页面
4. 点击"新建课程"
5. 上传封面图片（测试 JPG、PNG 格式，大小 < 2MB）
6. 填写其他必填字段
7. 点击"确定"提交
8. 验证：
   - ✅ 提交成功，无错误提示
   - ✅ 课程卡片正确显示封面
   - ✅ 数据库 `cover_image` 字段存储的是路径，不是 base64

## 修复日期

2024年（根据实际日期填写）

## 修复人员

Claude Code 自动生成
