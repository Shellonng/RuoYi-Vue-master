# 小节视频上传增强功能实现说明

## 功能概述
在小节详情页面上传视频时,系统会自动执行以下操作:
1. 将视频信息写入`video`表
2. 将视频作为课程资源记录到`course_resource`表
3. 将该小节关联的知识点自动关联到该视频资源(`course_resource_kp`表)

## 实现细节

### 一、新增的数据库实体类

#### 1. Video.java - 视频表实体类
**位置**: `ruoyi-system/src/main/java/com/ruoyi/system/domain/Video.java`

**主要字段**:
- `id`: 视频ID
- `courseId`: 所属课程ID
- `title`: 视频标题
- `filePath`: 视频文件路径
- `fileSize`: 文件大小(字节)
- `duration`: 视频时长(秒)
- `uploadedBy`: 上传者ID
- `status`: 状态(uploading/processing/published/offline)
- `viewCount`: 观看次数

#### 2. CourseResource.java - 课程资源表实体类
**位置**: `ruoyi-system/src/main/java/com/ruoyi/system/domain/CourseResource.java`

**主要字段**:
- `id`: 资源ID
- `courseId`: 所属课程ID
- `name`: 资源名称
- `fileType`: 文件类型(mp4, pdf等)
- `fileSize`: 文件大小
- `fileUrl`: 文件URL
- `uploadUserId`: 上传用户ID
- `downloadCount`: 下载次数

#### 3. CourseResourceKp.java - 资源知识点关联表实体类
**位置**: `ruoyi-system/src/main/java/com/ruoyi/system/domain/CourseResourceKp.java`

**主要字段**:
- `id`: 关联ID
- `resourceId`: 资源ID
- `kpId`: 知识点ID
- `isConfirmed`: 是否已确认(0-未确认, 1-已确认)

### 二、数据访问层(Mapper)

创建了以下Mapper接口和XML配置:

1. **VideoMapper.java** & **VideoMapper.xml**
   - 位置: `ruoyi-system/src/main/java/com/ruoyi/system/mapper/VideoMapper.java`
   - XML位置: `ruoyi-system/src/main/resources/mapper/system/VideoMapper.xml`
   - 提供视频的增删改查操作

2. **CourseResourceMapper.java** & **CourseResourceMapper.xml**
   - 位置: `ruoyi-system/src/main/java/com/ruoyi/system/mapper/CourseResourceMapper.java`
   - XML位置: `ruoyi-system/src/main/resources/mapper/system/CourseResourceMapper.xml`
   - 提供课程资源的增删改查操作

3. **CourseResourceKpMapper.java** & **CourseResourceKpMapper.xml**
   - 位置: `ruoyi-system/src/main/java/com/ruoyi/system/mapper/CourseResourceKpMapper.java`
   - XML位置: `ruoyi-system/src/main/resources/mapper/system/CourseResourceKpMapper.xml`
   - 提供资源知识点关联的操作,支持批量插入

### 三、业务逻辑层(Service)

创建了以下Service接口和实现类:

1. **IVideoService** & **VideoServiceImpl**
   - 接口位置: `ruoyi-system/src/main/java/com/ruoyi/system/service/IVideoService.java`
   - 实现位置: `ruoyi-system/src/main/java/com/ruoyi/system/service/impl/VideoServiceImpl.java`

2. **ICourseResourceService** & **CourseResourceServiceImpl**
   - 接口位置: `ruoyi-system/src/main/java/com/ruoyi/system/service/ICourseResourceService.java`
   - 实现位置: `ruoyi-system/src/main/java/com/ruoyi/system/service/impl/CourseResourceServiceImpl.java`

3. **ICourseResourceKpService** & **CourseResourceKpServiceImpl**
   - 接口位置: `ruoyi-system/src/main/java/com/ruoyi/system/service/ICourseResourceKpService.java`
   - 实现位置: `ruoyi-system/src/main/java/com/ruoyi/system/service/impl/CourseResourceKpServiceImpl.java`
   - 包含批量插入资源知识点关联的方法

### 四、核心业务逻辑修改

#### SectionServiceImpl.updateSection() 方法增强

**位置**: `ruoyi-system/src/main/java/com/ruoyi/system/service/impl/SectionServiceImpl.java`

**关键修改**:
```java
// 使用BusinessUserUtils获取当前业务用户ID
Long uploadUserId = BusinessUserUtils.getCurrentBusinessUserId();
```

**说明**: 
- 使用 `BusinessUserUtils.getCurrentBusinessUserId()` 获取当前登录用户的业务ID（user表的id）
- 这避免了与若依系统自带的sys_user表的ID冲突
- 确保所有业务表都使用统一的user_id关联

**修改内容**:
```java
@Override
@Transactional
public int updateSection(Section section)
{
    // 1. 获取旧的小节信息,判断视频URL是否有变化
    Section oldSection = sectionMapper.selectSectionById(section.getId());
    String oldVideoUrl = oldSection != null ? oldSection.getVideoUrl() : null;
    String newVideoUrl = section.getVideoUrl();
    
    // 2. 更新小节基本信息
    int result = sectionMapper.updateSection(section);
    
    // 3. 如果视频URL有变化,则同步处理
    if (result > 0 && newVideoUrl != null && !newVideoUrl.equals(oldVideoUrl))
    {
        // 3.1 获取章节信息以获取课程ID
        Chapter chapter = chapterMapper.selectChapterById(section.getChapterId());
        
        // 3.2 写入video表
        Video video = new Video();
        video.setCourseId(courseId);
        video.setTitle(section.getTitle());
        video.setFilePath(newVideoUrl);
        // ... 设置其他字段
        videoService.insertVideo(video);
        
        // 3.3 写入course_resource表
        CourseResource resource = new CourseResource();
        resource.setCourseId(courseId);
        resource.setName(section.getTitle());
        resource.setFileUrl(newVideoUrl);
        // ... 设置其他字段
        courseResourceService.insertCourseResource(resource);
        
        // 3.4 关联该小节的知识点到course_resource_kp表
        List<SectionKp> sectionKpList = sectionKpService.selectSectionKpListBySectionId(section.getId());
        if (sectionKpList != null && !sectionKpList.isEmpty())
        {
            Long[] kpIds = sectionKpList.stream()
                .map(SectionKp::getKpId)
                .toArray(Long[]::new);
            courseResourceKpService.batchInsertCourseResourceKp(resource.getId(), kpIds);
        }
    }
    
    return result;
}
```

**关键特性**:
- 使用`@Transactional`注解确保数据一致性
- 只在视频URL发生变化时才执行额外的数据写入操作
- 自动从小节获取课程ID和知识点信息
- 尝试获取视频文件大小(如果文件存在于服务器)
- 自动从文件名提取文件类型

## 数据流转图

```
用户上传视频
    ↓
前端调用 updateSection API
    ↓
SectionController.edit()
    ↓
SectionServiceImpl.updateSection()
    ↓
├─→ 更新 section 表 (videoUrl字段)
├─→ 写入 video 表 (视频元数据)
├─→ 写入 course_resource 表 (作为课程资源)
└─→ 写入 course_resource_kp 表 (关联小节的知识点)
```

## 使用说明

### 前端无需修改
前端代码保持不变,继续使用现有的视频上传逻辑即可。当调用`updateSection`接口更新`videoUrl`时,后端会自动完成以下操作:
1. 更新小节的视频URL
2. 创建视频记录
3. 创建课程资源记录
4. 关联知识点

### 数据一致性保证
- 整个操作在事务中执行,任何步骤失败都会回滚
- 只有当videoUrl发生实际变化时才会触发额外的写入操作
- 避免重复创建相同视频的多条记录

## 注意事项

1. **文件大小获取**: 系统会尝试读取服务器上的视频文件以获取文件大小,如果文件不存在或无法访问,会将文件大小设为0

2. **文件类型识别**: 系统会从视频URL中提取文件扩展名作为文件类型,默认为"mp4"

3. **知识点关联**: 只有当小节已经关联了知识点时,这些知识点才会被自动关联到视频资源

4. **上传者ID**: 使用 `BusinessUserUtils.getCurrentBusinessUserId()` 获取当前业务用户的ID，确保与业务表的user_id字段一致，避免与sys_user表冲突

5. **视频状态**: 新上传的视频状态默认为"published"(已发布)

## 测试建议

1. **正常上传测试**: 在小节详情页上传新视频,验证三张表都有相应记录
2. **更新视频测试**: 替换已有视频,验证会创建新的记录
3. **知识点关联测试**: 先为小节关联知识点,再上传视频,验证知识点是否正确关联到视频资源
4. **事务回滚测试**: 模拟某个步骤失败,验证事务是否正确回滚

## 数据库表结构参考

### video表
```sql
CREATE TABLE `video` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '视频ID',
  `course_id` bigint(20) NOT NULL COMMENT '课程ID',
  `title` varchar(200) NOT NULL COMMENT '视频标题',
  `file_path` varchar(500) NOT NULL COMMENT '视频文件路径',
  `file_size` bigint(20) DEFAULT NULL COMMENT '文件大小（字节）',
  `duration` int(11) DEFAULT NULL COMMENT '时长（秒）',
  `status` enum('uploading','processing','published','offline') DEFAULT 'uploading',
  `uploaded_by` bigint(20) DEFAULT NULL COMMENT '上传者ID',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### course_resource表
```sql
CREATE TABLE `course_resource` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '资源ID',
  `course_id` bigint(20) NOT NULL COMMENT '所属课程ID',
  `name` varchar(255) NOT NULL COMMENT '资源名称',
  `file_type` varchar(50) NOT NULL COMMENT '文件类型',
  `file_url` varchar(500) NOT NULL COMMENT '文件URL',
  `upload_user_id` bigint(20) NOT NULL COMMENT '上传用户ID',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### course_resource_kp表
```sql
CREATE TABLE `course_resource_kp` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `resource_id` bigint(20) DEFAULT NULL COMMENT '资源ID',
  `kp_id` bigint(20) DEFAULT NULL COMMENT '知识点ID',
  `is_confirmed` tinyint(1) DEFAULT '0' COMMENT '教师是否确认',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_resource_kp` (`resource_id`,`kp_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## 扩展建议

1. **视频转码**: 可以添加视频转码功能,上传后自动转换为多种格式和分辨率
2. **封面自动提取**: 可以使用ffmpeg自动从视频中提取封面图
3. **视频时长自动识别**: 使用ffmpeg获取视频的实际时长
4. **去重机制**: 可以添加MD5校验,避免上传相同内容的视频
5. **异步处理**: 对于大视频文件,可以考虑使用消息队列进行异步处理

---

**创建时间**: 2025-11-26
**功能版本**: v1.0
**开发者**: AI Assistant
