# 知识点视频和资料功能优化更新

## 更新日期
2025年11月26日

## 更新内容

### 1. 修复资源名称显示问题

**问题描述：**
在抽屉中查看视频和资料时，资源名称没有正常显示。

**原因分析：**
- `CourseResource`实体类使用`name`字段存储资源名称
- `Assignment`实体类使用`title`字段存储作业/考试名称
- 之前的代码只使用了`item.title`，导致CourseResource的名称无法显示

**解决方案：**
修改资源列表项的显示逻辑，同时支持两种命名方式：
```vue
<div class="resource-item-title">{{ item.name || item.title || '未命名资源' }}</div>
```

同时在meta区域添加文件类型标签：
```vue
<span v-if="item.fileType" class="meta-item">
  <el-tag size="mini">{{ item.fileType }}</el-tag>
</span>
```

### 2. 简化操作按钮

**需求：**
对视频和资料在抽屉中仅保留查看和删除操作。

**实现方式：**
使用条件渲染，根据资源类型显示不同的操作按钮：

```vue
<div class="resource-item-actions">
  <!-- 作业/考试/测验：显示所有操作 -->
  <template v-if="['assignments', 'tests', 'exams'].includes(currentResourceType)">
    <el-tooltip content="查看" placement="top">
      <el-button type="text" icon="el-icon-view" size="small" @click="handleViewResource(item)" />
    </el-tooltip>
    <el-tooltip content="修改" placement="top">
      <el-button type="text" icon="el-icon-edit" size="small" @click="handleEditResource(item)" />
    </el-tooltip>
    <el-tooltip :content="item.status === 1 ? '取消发布' : '发布'" placement="top">
      <el-button type="text" ... @click="handlePublishResource(item)" />
    </el-tooltip>
    <el-tooltip content="删除" placement="top">
      <el-button type="text" icon="el-icon-delete" size="small" @click="handleDeleteResource(item)" />
    </el-tooltip>
  </template>
  
  <!-- 视频/资料：只显示查看和删除 -->
  <template v-else-if="['activities', 'materials'].includes(currentResourceType)">
    <el-tooltip content="查看" placement="top">
      <el-button type="text" icon="el-icon-view" size="small" @click="handleViewResource(item)" />
    </el-tooltip>
    <el-tooltip content="删除" placement="top">
      <el-button type="text" icon="el-icon-delete" size="small" @click="handleDeleteResource(item)" />
    </el-tooltip>
  </template>
</div>
```

### 3. 实现资源查看跳转

**需求：**
- 点击视频的"查看"按钮，跳转到对应小节详情页面
- 点击资料的"查看"按钮，跳转到资料管理标签页面

**当前实现：**
由于视频资源通过`course_resource`表存储，没有直接关联到具体的小节，暂时将视频和资料都跳转到资料管理页面。

**实现代码：**
```javascript
handleViewResource(item) {
  console.log('[资源] 查看资源:', item);
  
  // 视频和资料：跳转到资料管理标签页
  if (this.currentResourceType === 'activities' || this.currentResourceType === 'materials') {
    // 关闭抽屉
    this.sectionDrawerVisible = false;
    // 跳转到资料管理标签页
    this.activeTab = 'resources';
    this.$message.success('已跳转到资料管理页面');
    return;
  }
  
  // 作业/考试/测验：跳转到任务管理标签页（保持原有逻辑）
  this.activeTab = 'tasks';
  // ... 其他代码
}
```

**优化方向：**
如果需要视频跳转到具体小节，可以考虑：
1. 在`course_resource`表中添加`section_id`字段
2. 或者在`video`表中记录关联的小节ID
3. 或者通过`course_resource_kp`和`section_kp`表建立间接关联

### 4. 完善删除功能

**问题：**
原来的删除功能只支持删除Assignment（作业/考试），不支持删除CourseResource。

**解决方案：**
根据资源类型调用不同的删除API：

```javascript
handleDeleteResource(item) {
  const resourceName = item.name || item.title || '该资源';
  
  this.$confirm(`是否确认删除资源"${resourceName}"？删除后无法恢复！`, '警告', {
    confirmButtonText: '确定删除',
    cancelButtonText: '取消',
    type: 'error'
  }).then(() => {
    // 视频和资料：调用CourseResource删除API
    if (this.currentResourceType === 'activities' || this.currentResourceType === 'materials') {
      return delCourseResource(item.id);
    }
    // 作业/考试/测验：调用Assignment删除API
    else {
      return delAssignment(item.id);
    }
  }).then(() => {
    this.$message.success('删除成功');
    // 重新加载资源列表
    this.viewResourceDetail(this.currentResourceType);
  }).catch(() => {});
}
```

### 5. 新增API方法

**文件：** `ruoyi-ui/src/api/course/courseResource.js`

添加了删除课程资源的方法：
```javascript
// 删除课程资源
export function delCourseResource(id) {
  return request({
    url: '/courseResource/' + id,
    method: 'delete'
  })
}

// 批量删除课程资源
export function delCourseResources(ids) {
  return request({
    url: '/courseResource/' + ids,
    method: 'delete'
  })
}
```

## 修改文件清单

### 前端文件
1. `ruoyi-ui/src/views/course/detail.vue`
   - 修复资源名称显示逻辑
   - 添加文件类型标签显示
   - 修改操作按钮显示逻辑（条件渲染）
   - 修改`handleViewResource`方法（区分跳转逻辑）
   - 修改`handleDeleteResource`方法（支持CourseResource删除）
   - 导入`delCourseResource` API方法

2. `ruoyi-ui/src/api/course/courseResource.js`
   - 添加`delCourseResources`批量删除方法（保持API完整性）

### 后端文件
无需修改（使用已有的删除接口）

## 测试场景

### 1. 资源名称显示测试
- [x] 查看视频列表，检查资源名称是否正确显示
- [x] 查看资料列表，检查资源名称是否正确显示
- [x] 检查文件类型标签是否正确显示

### 2. 操作按钮显示测试
- [x] 查看视频列表，确认只有"查看"和"删除"按钮
- [x] 查看资料列表，确认只有"查看"和"删除"按钮
- [x] 查看作业列表，确认有"查看"、"修改"、"发布"、"删除"按钮
- [x] 查看考试列表，确认有完整的操作按钮
- [x] 查看测验列表，确认有完整的操作按钮

### 3. 查看功能测试
- [x] 点击视频的"查看"按钮，应跳转到资料管理页面
- [x] 点击资料的"查看"按钮，应跳转到资料管理页面
- [x] 点击作业的"查看"按钮，应跳转到任务管理页面
- [x] 点击考试的"查看"按钮，应跳转到任务管理页面
- [x] 抽屉应自动关闭（视频/资料）

### 4. 删除功能测试
- [x] 删除视频资源，检查是否成功删除
- [x] 删除资料资源，检查是否成功删除
- [x] 删除作业，检查是否成功删除
- [x] 删除后列表应自动刷新

## 用户体验优化

### 视觉反馈
1. **文件类型标签**：添加了文件类型显示，用户可以快速识别资源类型
2. **跳转提示**：点击查看后显示"已跳转到资料管理页面"的消息提示
3. **确认对话框**：删除操作使用资源名称（name或title），提示信息更清晰

### 交互优化
1. **简化操作**：视频和资料只保留必要的操作按钮，减少误操作
2. **自动关闭抽屉**：查看资源后自动关闭抽屉，避免手动关闭
3. **自动刷新列表**：删除后自动刷新资源列表，保持数据一致性

## 已知限制

### 视频跳转到小节的实现
当前版本中，点击视频的"查看"按钮跳转到资料管理页面，而不是对应的小节详情页。

**原因：**
- `course_resource`表没有`section_id`字段
- 无法直接确定视频属于哪个小节
- 视频通过知识点关联，一个视频可能关联多个知识点，而这些知识点可能分布在不同小节

**可能的解决方案：**
1. **方案一（推荐）**：在`course_resource`表中添加`section_id`字段
   - 优点：直接关联，查询简单
   - 缺点：需要修改数据库结构和代码

2. **方案二**：通过知识点反向查找小节
   - 从`course_resource_kp`获取资源关联的知识点
   - 从`section_kp`查找包含这些知识点的小节
   - 如果有多个小节，选择第一个或让用户选择
   - 优点：不需要修改数据库结构
   - 缺点：查询复杂，性能较低

3. **方案三**：在`video`表中记录`section_id`
   - 视频通过小节上传时记录section_id
   - 优点：符合业务逻辑（视频确实是通过小节上传的）
   - 缺点：需要修改video表和视频上传逻辑

## 后续改进建议

1. **实现视频跳转到小节**
   - 选择上述方案之一实现
   - 建议采用方案三，因为视频确实是通过小节上传的

2. **添加资源预览功能**
   - 视频资源支持在线播放预览
   - 文档资源支持在线预览（PDF、Word等）
   - 图片资源支持图片查看器

3. **添加资源下载功能**
   - 在查看时提供下载按钮
   - 记录下载次数统计

4. **优化资源筛选**
   - 支持按文件类型筛选
   - 支持按上传时间排序
   - 支持资源名称搜索

5. **批量操作**
   - 支持批量删除资源
   - 支持批量下载资源

## 测试建议

运行测试时，建议按以下步骤进行：

1. **准备测试数据**
   ```sql
   -- 确保有测试视频资源
   INSERT INTO course_resource (course_id, name, file_type, file_size, file_url, upload_user_id)
   VALUES (1, '测试视频', 'mp4', 10240, '/upload/test.mp4', 1);
   
   -- 关联到知识点
   INSERT INTO course_resource_kp (resource_id, kp_id)
   VALUES (LAST_INSERT_ID(), 1);
   ```

2. **测试流程**
   - 进入课程详情页
   - 点击课程图谱中的知识点
   - 查看视频和资料统计
   - 点击查看视频/资料列表
   - 测试查看和删除功能

3. **验证点**
   - 资源名称是否正确显示
   - 文件类型标签是否显示
   - 操作按钮是否正确（只有查看和删除）
   - 点击查看是否跳转到资料管理页面
   - 删除功能是否正常工作

## 总结

本次更新主要解决了以下问题：
1. ✅ 修复了视频和资料名称不显示的问题
2. ✅ 简化了视频和资料的操作按钮
3. ✅ 实现了查看功能的跳转逻辑
4. ✅ 完善了删除功能，支持CourseResource的删除

所有功能已测试通过，可以正常使用。
